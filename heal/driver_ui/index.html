<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VGR Driver Smoke Test â€” Simple Web UI (with Teleop)</title>
  <script src="https://cdn.jsdelivr.net/npm/roslib/build/roslib.min.js"></script>
  <style>
    :root{
      --bg:#0b1020;--panel:#111832;--muted:#7f8ba8;--text:#e8ecf6;--accent:#6ea8fe;--accent-2:#9cffcb;--warn:#ffcc66;--bad:#ff6b6b;
      --radius:14px;--gap:14px;--shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box} body{margin:0;background:radial-gradient(1100px 800px at 20% -20%,#1f2a4d,transparent) var(--bg);color:var(--text);font:15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"}
    header{padding:20px 18px 8px;display:flex;align-items:center;gap:10px}
    header .dot{width:10px;height:10px;border-radius:50%;background:var(--bad);box-shadow:0 0 0 2px rgba(255,255,255,.08)}
    header h1{font-size:18px;margin:0;font-weight:700}
    header small{color:var(--muted)}
    .wrap{padding:16px;max-width:1100px;margin:0 auto;}
    .grid{display:grid;grid-template-columns:1.1fr 1fr;gap:var(--gap)}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.07);font-size:14px;letter-spacing:.3px;text-transform:uppercase;color:var(--muted)}
    .card .content{padding:14px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type="text"], input[type="number"], select, textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:#0f152b;color:var(--text);outline:none}
    textarea{min-height:70px;resize:vertical}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
    .btn{appearance:none;border:none;background:linear-gradient(180deg, #2b3b6a, #22345f);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.35);transition:transform .05s ease, opacity .2s}
    .btn:hover{opacity:.95}.btn:active{transform:translateY(1px)} .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn.secondary{background:linear-gradient(180deg, #28435a, #1e3549)}
    .btn.warn{background:linear-gradient(180deg, #5a3d1d, #4b2f13);color:#ffd99b}
    .btn.bad{background:linear-gradient(180deg, #5a1f1f, #411515);color:#ffbbbb}
    .btn.good{background:linear-gradient(180deg, #275b3e, #1f4631);color:#b6ffd7}
    .actions{display:flex;flex-wrap:wrap;gap:10px}
    .stat{font-variant-numeric:tabular-nums;padding:8px 12px;border-radius:12px;background:#0f162f;border:1px solid rgba(255,255,255,.08);display:inline-flex;gap:8px;align-items:center}
    code.inline{background:#0f162f;border:1px solid rgba(255,255,255,.08);padding:2px 6px;border-radius:6px}
    .log{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;background:#0a0f21;border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px;height:180px;overflow:auto;white-space:pre-wrap}
    .footer{color:var(--muted);padding:16px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#0f162f;border:1px solid rgba(255,255,255,.08)}
    .right{display:flex;gap:10px;align-items:center;margin-left:auto}
    .teleop-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .nudge{padding:12px 8px;border-radius:8px;background:#0f162f;border:1px solid rgba(255,255,255,.04);text-align:center;cursor:pointer}
    .kbdHint{color:var(--muted);font-size:12px;margin-top:8px}
  </style>
</head>
<body>
  <header>
    <div id="statusDot" class="dot" title="Disconnected"></div>
    <h1>VGR Driver Smoke Test â€” Simple Web UI</h1>
    <small id="connText">Disconnected</small>
    <div class="right">
      <span class="pill">Topics: <code class="inline" id="topicCmd">/vgr_driver_smoke_test/cmd</code> â€¢ <code class="inline" id="topicStatus">/vgr_driver_smoke_test/status</code> â€¢ <code class="inline" id="topicTeleop">/vgr_driver_smoke_test/teleop</code></span>
    </div>
  </header>

  <div class="wrap">
    <div class="grid">
      <!-- Connection & Config -->
      <section class="card">
        <h2>Connection</h2>
        <div class="content">
          <div class="row" style="margin-bottom:10px">
            <div class="col-8">
              <label>rosbridge WebSocket URL</label>
              <input id="wsUrl" type="text" value="ws://localhost:9090" />
            </div>
            <div class="col-4">
              <label>Node namespace (for ~cmd / ~status)</label>
              <input id="ns" type="text" value="/vgr_driver_smoke_test" />
            </div>
          </div>
          <div class="actions">
            <button id="btnConnect" class="btn good">Connect</button>
            <button id="btnDisconnect" class="btn bad" disabled>Disconnect</button>
            <span class="stat">Last status: <strong id="lastStatus">â€”</strong></span>
            <span class="stat">Steps: <strong id="stepCount">0</strong></span>
            <span class="stat">Updated: <strong id="lastTime">â€”</strong></span>
          </div>
        </div>
      </section>

      <!-- Quick actions -->
      <section class="card">
        <h2>Playback & File</h2>
        <div class="content">
          <div class="actions" style="margin-bottom:10px">
            <button data-cmd="play" class="btn">â–¶ Play</button>
            <button data-cmd="stop" class="btn bad">â–  Stop</button>
            <button data-cmd="list" class="btn secondary">List (see logs)</button>
          </div>
          <div class="actions">
            <button data-cmd="save" class="btn">ðŸ’¾ Save</button>
            <button data-cmd="load" class="btn">ðŸ“‚ Load</button>
            <button data-cmd="clear" class="btn warn">ðŸ§¹ Clear</button>
          </div>
          <p class="footer">Save/Load uses the node's <code class="inline">~path</code> param (default <code class="inline">poses/driver_test.yaml</code>).</p>
        </div>
      </section>

      <!-- Record: Joint / TCP -->
      <section class="card">
        <h2>Record Pose</h2>
        <div class="content">
          <div class="row" style="margin-bottom:10px">
            <div class="col-3">
              <label>Joint dwell (s)</label>
              <input id="jointDwell" type="number" value="0.0" step="0.05" />
            </div>
            <div class="col-3" style="display:flex;align-items:end">
              <button id="btnRecordJoint" class="btn">Record Joint</button>
            </div>
          </div>
          <div class="row">
            <div class="col-3">
              <label>TCP dwell (s)</label>
              <input id="tcpDwell" type="number" value="0.0" step="0.05" />
            </div>
            <div class="col-3">
              <label>TCP speed (mm/s)</label>
              <input id="tcpSpeed" type="number" value="200" step="10" />
            </div>
            <div class="col-3" style="display:flex;align-items:end">
              <button id="btnRecordTCP" class="btn">Record TCP</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Gripper -->
      <section class="card">
        <h2>Gripper</h2>
        <div class="content">
          <div class="row">
            <div class="col-4">
              <label>Action</label>
              <select id="gripAction">
                <option value="open">open</option>
                <option value="close">close</option>
              </select>
            </div>
            <div class="col-4">
              <label>Force (N)</label>
              <input id="gripForce" type="number" value="100" step="1" />
            </div>
            <div class="col-4" style="display:flex;align-items:end">
              <button id="btnGrip" class="btn">Add Gripper Step</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Teleop -->
      <section class="card">
        <h2>Teleop (remote)</h2>
        <div class="content">
          <!-- Step sizes -->
          <div class="row" style="margin-bottom:10px">
            <div class="col-4">
              <label>Step translation (mm)</label>
              <input id="teleopTrans" type="number" value="5" step="1" />
            </div>
            <div class="col-4">
              <label>Step yaw (deg)</label>
              <input id="teleopYaw" type="number" value="5" step="0.5" />
            </div>
            <div class="col-4">
              <label>Step roll / pitch (deg)</label>
              <div style="display:flex; gap:8px">
                <input id="teleopRoll" type="number" value="5" step="0.5" title="Roll step (deg)" />
                <input id="teleopPitch" type="number" value="5" step="0.5" title="Pitch step (deg)" />
              </div>
            </div>
          </div>

          <div class="actions" style="margin-bottom:10px">
            <button id="btnTeleopStart" class="btn good">Start Teleop</button>
            <button id="btnTeleopStop" class="btn bad">Stop Teleop</button>
            <label style="display:flex;align-items:center;gap:8px;margin-left:8px"><input id="sendAlsoToCmd" type="checkbox" /> Also send via <code class="inline">~cmd</code></label>
          </div>

          <!-- Directional and RPY buttons -->
          <div style="margin-bottom:8px">
            <div class="teleop-grid">
              <!-- Row 1 -->
              <div></div>
              <div id="btnNudgeW" class="nudge">W<br><small>+X</small></div>
              <div></div>

              <!-- Row 2 -->
              <div id="btnNudgeA" class="nudge">A<br><small>+Y</small></div>
              <div id="btnNudgeS" class="nudge">S<br><small>-X</small></div>
              <div id="btnNudgeD" class="nudge">D<br><small>-Y</small></div>

              <!-- Row 3 -->
              <div id="btnNudgeR" class="nudge">R<br><small>+Z</small></div>
              <div id="btnNudgeSpace" class="nudge">SPACE<br><small>STOP</small></div>
              <div id="btnNudgeF" class="nudge">F<br><small>-Z</small></div>

              <!-- Row 4 -->
              <div id="btnNudgeQ" class="nudge">Q<br><small>+Yaw</small></div>
              <div id="btnNudgeG" class="nudge">G<br><small>Recapture</small></div>
              <div id="btnNudgeE" class="nudge">E<br><small>-Yaw</small></div>

              <!-- Row 5 (new): Roll/Pitch -->
              <div id="btnRollPlus" class="nudge">Z<br><small>+Roll</small></div>
              <div id="btnPitchPlus" class="nudge">C<br><small>+Pitch</small></div>
              <div id="btnRollMinus" class="nudge">X<br><small>-Roll</small></div>

              <!-- Row 6 (new): Pitch- and Print -->
              <div></div>
              <div id="btnPitchMinus" class="nudge">V<br><small>-Pitch</small></div>
              <div id="btnPrint" class="nudge">P<br><small>Print</small></div>
            </div>
            <div class="kbdHint">
              Tip: enable <strong>Page keys</strong> below and use
              <strong>W/A/S/D</strong> (X/Y), <strong>R/F</strong> (Z),
              <strong>Q/E</strong> (Yaw), <strong>Z/X</strong> (Â±Roll),
              <strong>C/V</strong> (Â±Pitch), <strong>G</strong> (Recapture),
              <strong>P</strong> (Print), <strong>Space</strong> (Stop).
            </div>
          </div>

          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <label style="display:flex;align-items:center;gap:8px"><input id="enablePageKeys" type="checkbox" /> Enable Page keys</label>
            <label style="display:flex;align-items:center;gap:8px;margin-left:12px"><input id="teleopLocalOnly" type="checkbox" /> Publish only to <code class="inline">/teleop</code> (don't also send to <code class="inline">~cmd</code>)</label>
          </div>

          <p class="footer">The teleop controls publish JSON (std_msgs/String) to the teleop topic. Formats supported by the node include combinations of <code>dx/dy/dz</code> (meters) and <code>roll/pitch/yaw</code> (radians).</p>
        </div>
      </section>

      <!-- Raw JSON & Logs -->
      <section class="card" style="grid-column:1/-1">
        <h2>Advanced</h2>
        <div class="content">
          <div class="row" style="margin-bottom:10px">
            <div class="col-8">
              <label>Send a raw JSON command to ~cmd</label>
              <textarea id="rawJson">{"cmd":"list"}</textarea>
            </div>
            <div class="col-4" style="display:flex;align-items:end">
              <button id="btnSendRaw" class="btn">Send Raw JSON</button>
            </div>
          </div>
          <div class="actions" style="margin-bottom:10px">
            <label style="display:flex;align-items:center;gap:8px"><input id="toggleLogs" type="checkbox" /> Listen to ROS logs (<code class="inline">/rosout</code>)</label>
          </div>
          <div class="row">
            <div class="col-12">
              <div class="log" id="log"></div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <p class="footer">How it works: the Teleop panel publishes <code class="inline">std_msgs/String</code> JSON to <code class="inline">/&lt;ns&gt;/teleop</code>. If enabled, it also sends the same JSON to <code class="inline">~cmd</code> so the node can react via its existing command path. Scroll the log to see published JSON and ROS logs.</p>
  </div>

  <script>
    // --- Helpers ---
    const $ = (sel)=>document.querySelector(sel);
    const pad = (n)=>String(n).padStart(2,'0');
    const nowStr = ()=>{const d=new Date(); return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`};

    function normalizeNs(ns){
      if(!ns) return '/vgr_driver_smoke_test';
      ns = ns.trim();
      if(!ns.startsWith('/')) ns = '/' + ns;
      return ns.replace(/\/$/,'');
    }

    function updateTopicLabels(){
      const ns = normalizeNs($('#ns').value);
      $('#topicCmd').textContent = `${ns}/cmd`;
      $('#topicStatus').textContent = `${ns}/status`;
      $('#topicTeleop').textContent = `${ns}/teleop`;
    }

    // --- ROS state ---
    let ros = null;
    let cmdTopic = null;
    let statusTopic = null;
    let teleopTopic = null;
    let rosoutTopic = null;

    function setConnected(yes){
      $('#statusDot').style.background = yes ? 'var(--accent-2)' : 'var(--bad)';
      $('#connText').textContent = yes ? 'Connected' : 'Disconnected';
      $('#btnConnect').disabled = yes;
      $('#btnDisconnect').disabled = !yes;
      document.querySelectorAll('.btn').forEach(b=>{
        if(['btnConnect'].includes(b.id)) return;
        b.disabled = !yes && !b.classList.contains('bad');
      });
    }

    function logLine(text){
      const log = $('#log');
      log.textContent += `[${nowStr()}] ${text}\n`;
      log.scrollTop = log.scrollHeight;
    }

    function buildTopics(){
      const ns = normalizeNs($('#ns').value);
      cmdTopic = new ROSLIB.Topic({ ros, name: `${ns}/cmd`, messageType: 'std_msgs/String'});
      statusTopic = new ROSLIB.Topic({ ros, name: `${ns}/status`, messageType: 'std_msgs/String'});
      teleopTopic = new ROSLIB.Topic({ ros, name: `${ns}/teleop`, messageType: 'std_msgs/String'});
    }

    function subscribeStatus(){
      if(!statusTopic) return;
      statusTopic.subscribe((msg)=>{
        try {
          const payload = JSON.parse(msg.data);
          $('#lastStatus').textContent = payload.status ?? msg.data;
          $('#stepCount').textContent = payload.count ?? 'â€”';
        } catch(e){
          $('#lastStatus').textContent = msg.data;
        }
        $('#lastTime').textContent = nowStr();
      });
    }

    function toggleRosout(on){
      if(!ros) return;
      if(on){
        if(!rosoutTopic){
          rosoutTopic = new ROSLIB.Topic({ ros, name: '/rosout', messageType: 'rosgraph_msgs/Log'});
        }
        rosoutTopic.subscribe((msg)=>{
          const want = (msg.name && msg.name.includes('vgr_driver_smoke_test')) || (msg.msg && msg.msg.includes('[driver_smoke]'));
          if(want){
            logLine(msg.msg);
          }
        });
      } else {
        if(rosoutTopic){ rosoutTopic.unsubscribe(); }
      }
    }

    function publishToCmd(obj){
      if(!cmdTopic){ logLine('cmdTopic not ready'); return; }
      try{
        const m = new ROSLIB.Message({ data: JSON.stringify(obj) });
        cmdTopic.publish(m);
        logLine('â†’ sent to ~cmd: ' + JSON.stringify(obj));
      }catch(e){
        logLine('publish ~cmd error: ' + e.message);
      }
    }

    function publishToTeleop(obj){
      if(!teleopTopic){ logLine('teleopTopic not ready'); return; }
      try{
        const m = new ROSLIB.Message({ data: JSON.stringify(obj) });
        teleopTopic.publish(m);
        logLine('â†’ sent to /teleop: ' + JSON.stringify(obj));
      }catch(e){
        logLine('publish teleop error: ' + e.message);
      }
    }

    function publishCmd(obj){
      if(!cmdTopic){ logLine('Not connected'); return; }
      publishToCmd(obj);
    }

    // --- Teleop helper: decide where to send (teleopTopic always, ~cmd optionally) ---
    function sendTeleopCommand(obj){
      if(teleopTopic) publishToTeleop(obj);
      const sendAlso = $('#sendAlsoToCmd').checked;
      const localOnly = $('#teleopLocalOnly').checked;
      if(sendAlso && !localOnly && cmdTopic){
        try { publishToCmd(obj); } catch(e) { logLine('Failed sending teleop to ~cmd: ' + e.message); }
      }
    }

    // --- Event wiring ---
    $('#btnConnect').addEventListener('click', ()=>{
      const url = $('#wsUrl').value.trim();
      try{ localStorage.setItem('vgr_ws', url); localStorage.setItem('vgr_ns', normalizeNs($('#ns').value)); }catch{}
      ros = new ROSLIB.Ros({ url });
      ros.on('connection', ()=>{ setConnected(true); updateTopicLabels(); buildTopics(); subscribeStatus(); if($('#toggleLogs').checked) toggleRosout(true); logLine('Connected to ' + url); });
      ros.on('close', ()=>{ setConnected(false); logLine('Connection closed'); });
      ros.on('error', (err)=>{ setConnected(false); logLine('Connection error: ' + (err?.message||err)); });
    });

    $('#btnDisconnect').addEventListener('click', ()=>{ try{ if(ros){ ros.close(); } } catch(e){} });

    // existing command buttons (play/stop/list etc)
    document.querySelectorAll('button[data-cmd]').forEach(btn=>{
      btn.addEventListener('click', ()=> publishCmd({ cmd: btn.dataset.cmd }) );
    });

    // record buttons
    $('#btnRecordJoint').addEventListener('click', ()=>{
      const dwell = parseFloat($('#jointDwell').value||'0')||0;
      publishCmd({ cmd:'record_joint', dwell_s: dwell });
    });

    $('#btnRecordTCP').addEventListener('click', ()=>{
      const dwell = parseFloat($('#tcpDwell').value||'0')||0;
      const speed = parseFloat($('#tcpSpeed').value||'200')||200;
      publishCmd({ cmd:'record_tcp', dwell_s: dwell, speed_mm_s: speed });
    });

    // gripper
    $('#btnGrip').addEventListener('click', ()=>{
      const action = $('#gripAction').value;
      const force = parseFloat($('#gripForce').value || '') || 100;
      publishCmd({ cmd: 'add_gripper', action: action, force_n: force });
    });

    // raw JSON
    $('#btnSendRaw').addEventListener('click', ()=>{
      try{
        const obj = JSON.parse($('#rawJson').value);
        publishCmd(obj);
      }catch(e){
        logLine('Raw JSON parse error: ' + e.message);
      }
    });

    // logs toggle
    $('#toggleLogs').addEventListener('change', (e)=>{ toggleRosout(e.target.checked); });

    // Teleop: start/stop
    $('#btnTeleopStart').addEventListener('click', ()=>{
      const obj = { cmd: 'teleop_start' };
      sendTeleopCommand(obj);
    });
    $('#btnTeleopStop').addEventListener('click', ()=>{
      const obj = { cmd: 'teleop_stop' };
      sendTeleopCommand(obj);
    });

    // Teleop nudges helpers
    function nudge(dx=0, dy=0, dz=0, yaw_deg=0){
      const trans_mm = parseFloat($('#teleopTrans').value || '5') || 5;

      const dx_m = dx ? (trans_mm/1000.0) * Math.sign(dx) : 0;
      const dy_m = dy ? (trans_mm/1000.0) * Math.sign(dy) : 0;
      const dz_m = dz ? (trans_mm/1000.0) * Math.sign(dz) : 0;

      const yaw_rad = (typeof yaw_deg === 'number' && yaw_deg !== 0)
          ? (yaw_deg * Math.PI/180.0)
          : 0;

      const obj = { cmd: 'nudge', dx: dx_m, dy: dy_m, dz: dz_m };
      if (yaw_rad !== 0) obj.yaw = yaw_rad;

      sendTeleopCommand(obj);
    }

    function nudgeRoll(sign=+1){
      const deg = parseFloat($('#teleopRoll').value||'5') || 5;
      const rad = (sign * deg) * Math.PI/180.0;
      sendTeleopCommand({ cmd:'nudge', roll: rad });
    }

    function nudgePitch(sign=+1){
      const deg = parseFloat($('#teleopPitch').value||'5') || 5;
      const rad = (sign * deg) * Math.PI/180.0;
      sendTeleopCommand({ cmd:'nudge', pitch: rad });
    }

    // Nudge buttons: translation
    $('#btnNudgeW').addEventListener('click', ()=> nudge(+1,0,0,0)); // +X
    $('#btnNudgeS').addEventListener('click', ()=> nudge(-1,0,0,0)); // -X
    $('#btnNudgeA').addEventListener('click', ()=> nudge(0,+1,0,0)); // +Y
    $('#btnNudgeD').addEventListener('click', ()=> nudge(0,-1,0,0)); // -Y
    $('#btnNudgeR').addEventListener('click', ()=> nudge(0,0,+1,0)); // +Z
    $('#btnNudgeF').addEventListener('click', ()=> nudge(0,0,-1,0)); // -Z

    // Yaw buttons
    $('#btnNudgeQ').addEventListener('click', ()=> {
      const yaw_deg = parseFloat($('#teleopYaw').value||'5') || 5;
      sendTeleopCommand({ cmd:'nudge', yaw: yaw_deg * Math.PI/180.0 }); // +yaw
    });
    $('#btnNudgeE').addEventListener('click', ()=> {
      const yaw_deg = parseFloat($('#teleopYaw').value||'5') || 5;
      sendTeleopCommand({ cmd:'nudge', yaw: -yaw_deg * Math.PI/180.0 }); // -yaw
    });

    // Roll/Pitch buttons
    $('#btnRollPlus').addEventListener('click', ()=> nudgeRoll(+1));
    $('#btnRollMinus').addEventListener('click', ()=> nudgeRoll(-1));
    $('#btnPitchPlus').addEventListener('click', ()=> nudgePitch(+1));
    $('#btnPitchMinus').addEventListener('click', ()=> nudgePitch(-1));

    // Misc
    $('#btnNudgeG').addEventListener('click', ()=> sendTeleopCommand({ cmd: 'recapture' }));
    $('#btnNudgeSpace').addEventListener('click', ()=> sendTeleopCommand({ cmd: 'stop' }));
    $('#btnPrint').addEventListener('click', ()=> sendTeleopCommand({ cmd: 'print' }));

    // Page keyboard support
    let pageKeysEnabled = false;
    $('#enablePageKeys').addEventListener('change', (e)=>{
      pageKeysEnabled = e.target.checked;
      logLine('Page keys ' + (pageKeysEnabled ? 'enabled' : 'disabled') + '. Focus this tab and press keys.');
    });

    window.addEventListener('keydown', (ev)=>{
      if(!pageKeysEnabled) return;
      const key = ev.key.toLowerCase();
      if(key === 'w') { nudge(+1,0,0,0); ev.preventDefault(); }
      else if(key === 's'){ nudge(-1,0,0,0); ev.preventDefault(); }
      else if(key === 'a'){ nudge(0,+1,0,0); ev.preventDefault(); }
      else if(key === 'd'){ nudge(0,-1,0,0); ev.preventDefault(); }
      else if(key === 'r'){ nudge(0,0,+1,0); ev.preventDefault(); }
      else if(key === 'f'){ nudge(0,0,-1,0); ev.preventDefault(); }
      else if(key === 'q'){ const deg = parseFloat($('#teleopYaw').value||'5')||5; sendTeleopCommand({ cmd:'nudge', yaw:  deg*Math.PI/180.0 }); ev.preventDefault(); }
      else if(key === 'e'){ const deg = parseFloat($('#teleopYaw').value||'5')||5; sendTeleopCommand({ cmd:'nudge', yaw: -deg*Math.PI/180.0 }); ev.preventDefault(); }
      else if(key === 'z'){ nudgeRoll(+1); ev.preventDefault(); }
      else if(key === 'x'){ nudgeRoll(-1); ev.preventDefault(); }
      else if(key === 'c'){ nudgePitch(+1); ev.preventDefault(); }
      else if(key === 'v'){ nudgePitch(-1); ev.preventDefault(); }
      else if(key === 'g'){ sendTeleopCommand({ cmd: 'recapture' }); ev.preventDefault(); }
      else if(key === 'p'){ sendTeleopCommand({ cmd: 'print' }); ev.preventDefault(); }
      else if(ev.code === 'Space'){ sendTeleopCommand({ cmd: 'stop' }); ev.preventDefault(); }
    });

    // Restore from localStorage and initial setup
    $('#ns').addEventListener('input', updateTopicLabels);
    (function(){
      try{
        const url = localStorage.getItem('vgr_ws'); if(url) $('#wsUrl').value = url;
        const ns  = localStorage.getItem('vgr_ns'); if(ns) $('#ns').value = ns;
      }catch{}
      updateTopicLabels(); setConnected(false);
      logLine('Ready. Configure connection then click Connect.');
    })();

  </script>
</body>
</html>
